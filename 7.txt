include <stdio.h> 
#include <stdbool.h> 
 
#define MAX_PROCESSES 10 
#define MAX_RESOURCES 10 
 
int main() 
{ 
    int n, m; // n = number of processes, m = number of resources 
    int alloc[MAX_PROCESSES][MAX_RESOURCES]; 
    int max[MAX_PROCESSES][MAX_RESOURCES]; 
    int need[MAX_PROCESSES][MAX_RESOURCES]; 
    int avail[MAX_RESOURCES]; 
    bool finish[MAX_PROCESSES]; 
 
    printf("Enter the number of processes: "); 
    scanf("%d", &n); 
    printf("Enter the number of resources: "); 
    scanf("%d", &m); 
 
    printf("Enter the allocation matrix:\n"); 
    for (int i = 0; i < n; i++) 
        for (int j = 0; j < m; j++) 
            scanf("%d", &alloc[i][j]); 
 
    printf("Enter the maximum matrix:\n"); 
    for (int i = 0; i < n; i++) 
        for (int j = 0; j < m; j++) 
            scanf("%d", &max[i][j]); 
 
    printf("Enter the available resources:\n"); 
    for (int i = 0; i < m; i++) 
        scanf("%d", &avail[i]); 
 
    // Calculate need matrix 
    for (int i = 0; i < n; i++) 
        for (int j = 0; j < m; j++) 
            need[i][j] = max[i][j] - alloc[i][j]; 
 
    // Print the need matrix 
    printf("\nNeed Matrix:\n"); 
    for (int i = 0; i < n; i++) 
    { 
        printf("P%d: ", i); 
        for (int j = 0; j < m; j++) 
        { 
            printf("%d ", need[i][j]); 
        } 
        printf("\n"); 
    } 
 
    // Initialize finish array 
    for (int i = 0; i < n; i++) 
        finish[i] = false; 
 
    int safeSeq[MAX_PROCESSES]; 
    int work[MAX_RESOURCES]; 
    for (int i = 0; i < m; i++) 
        work[i] = avail[i]; 
 
    int count = 0; 
    bool found; 
 
    // Initial safety check to find safe sequence 
    while (count < n) 
    { 
        found = false; 
        for (int i = 0; i < n; i++) 
        { 
            if (!finish[i]) 
            { 
                bool canAllocate = true; 
                for (int j = 0; j < m; j++) 
                { 
                    if (need[i][j] > work[j]) 
                    { 
                        canAllocate = false; 
                        break; 
                    } 
                } 
                if (canAllocate) 
                { 
                    for (int j = 0; j < m; j++) 
                        work[j] += alloc[i][j]; 
 
                    safeSeq[count++] = i; 
                    finish[i] = true; 
                    found = true; 
                } 
            } 
        } 
 
        if (!found) 
        { 
            printf("\nSystem is NOT in a safe state (deadlock is possible).\n"); 
            return 0; 
        } 
    } 
 
    // If system is safe 
    printf("\nSystem is in a SAFE state.\nSafe Sequence: "); 
    for (int i = 0; i < n; i++) 
        printf("P%d ", safeSeq[i]); 
    printf("\n"); 
 
    // Now handle requests repeatedly 
    while (true) { 
        int reqProcess; 
        printf("\nEnter process number for request (-1 to exit): "); 
        scanf("%d", &reqProcess); 
 
        if (reqProcess == -1) { 
            printf("Exiting request loop.\n"); 
            break; 
        } 
 
        if (reqProcess < 0 || reqProcess >= n) { 
            printf("Invalid process number.\n"); 
            continue; 
        } 
 
        int request[MAX_RESOURCES]; 
        printf("Enter request vector: "); 
        for (int i = 0; i < m; i++) 
            scanf("%d", &request[i]); 
 
        // Check if request <= need 
        bool validRequest = true; 
        for (int i = 0; i < m; i++) { 
            if (request[i] > need[reqProcess][i]) { 
                printf("Error: Request exceeds the process's maximum need.\n"); 
                validRequest = false; 
                break; 
            } 
        } 
        if (!validRequest) continue; 
 
        // Check if request <= available 
        for (int i = 0; i < m; i++) { 
            if (request[i] > avail[i]) { 
                printf("Request cannot be granted immediately due to insufficient available 
resources.\n"); 
                validRequest = false; 
                break; 
            } 
        } 
        if (!validRequest) continue; 
 
        // Pretend to allocate requested resources 
        for (int i = 0; i < m; i++) { 
            avail[i] -= request[i]; 
            alloc[reqProcess][i] += request[i]; 
            need[reqProcess][i] -= request[i]; 
        } 
 
        // Re-run safety check after allocation 
        for (int i = 0; i < m; i++) 
            work[i] = avail[i]; 
        for (int i = 0; i < n; i++) 
            finish[i] = false; 
 
        count = 0; 
        bool foundSeq = true; 
 
        while (count < n) { 
            bool found = false; 
            for (int i = 0; i < n; i++) { 
                if (!finish[i]) { 
                    bool canAllocate = true; 
                    for (int j = 0; j < m; j++) { 
                        if (need[i][j] > work[j]) { 
                            canAllocate = false; 
                            break; 
                        } 
                    } 
                    if (canAllocate) { 
                        for (int j = 0; j < m; j++) 
                            work[j] += alloc[i][j]; 
                        safeSeq[count++] = i; 
                        finish[i] = true; 
                        found = true; 
                    } 
                } 
            } 
            if (!found) { 
                foundSeq = false; 
                break; 
            } 
        } 
 
        if (!foundSeq) { 
            // Rollback allocation 
            for (int i = 0; i < m; i++) { 
                avail[i] += request[i]; 
                alloc[reqProcess][i] -= request[i]; 
                need[reqProcess][i] += request[i]; 
            } 
            printf("Request cannot be granted as it leads to unsafe state.\n"); 
        } else { 
            printf("Request can be granted. So, new safe sequence: "); 
            for (int i = 0; i < n; i++) { 
                printf("P%d", safeSeq[i]); 
                if (i != n - 1) printf(" -> "); 
            } 
            printf("\n"); 
        } 
    } 
 
    return 0; 
} 