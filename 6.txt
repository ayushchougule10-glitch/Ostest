#include <semaphore.h> 
#include <stdio.h> 
#include <stdlib.h> 
#include <unistd.h> 
#include <pthread.h> 
 
sem_t mutex, wrt; 
int sharedvar = 99; 
int readercount = 0; 
pthread_t writers[5], readers[5]; 
 
void* reader(void* arg) 
{ 
    int id = (int)(long)arg; 
 
    sem_wait(&mutex); 
    readercount++; 
    if (readercount == 1) 
    { 
        sem_wait(&wrt); 
    } 
    sem_post(&mutex); 
 
    printf("Reader %d reads sharedvar = %d\n", id, sharedvar); 
 
    sem_wait(&mutex); 
    readercount--; 
    if (readercount == 0) 
    { 
        sem_post(&wrt); 
    } 
    sem_post(&mutex); 
 
    return NULL; 
} 
 
void* writer(void* arg) 
{ 
    int id = (int)(long)arg; 
 
    sem_wait(&wrt); 
    sharedvar += id; 
    printf("Writer %d updates sharedvar to %d\n", id, sharedvar); 
    sem_post(&wrt); 
 
    return NULL; 
} 
 
int main() 
{ 
    sem_init(&mutex, 0, 1); 
    sem_init(&wrt, 0, 1); 
 
    printf("Enter initial value of shared variable: "); 
    scanf("%d", &sharedvar); 
 
    int n; 
    printf("Enter number of readers and writers (max 5): "); 
    scanf("%d", &n); 
 
    for (int i = 0; i < n; i++) 
    { 
        pthread_create(&writers[i], NULL, writer, (void*)(long)(i + 1)); 
        pthread_create(&readers[i], NULL, reader, (void*)(long)(i + 1)); 
    } 
 
    for (int i = 0; i < n; i++) 
    { 
        pthread_join(writers[i], NULL); 
        pthread_join(readers[i], NULL); 
    } 
 
    sem_destroy(&mutex); 
    sem_destroy(&wrt); 
 
    return 0; 
}